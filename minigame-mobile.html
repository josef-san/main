<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dot Survivor: Mobile Compact</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        
        #ui {
            position: absolute; top: 10px; left: 10px; right: 10px; color: white;
            display: flex; justify-content: space-between; pointer-events: none;
            font-size: 12px; text-transform: uppercase; z-index: 10;
        }

        #warpProgress {
            position: absolute; top: 40px; left: 10px; color: #00fbff;
            font-size: 11px; font-weight: bold; text-shadow: 0 0 10px #00fbff; pointer-events: none;
        }

        #overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; background: rgba(10, 10, 10, 0.98);
            padding: 20px; border-radius: 15px; border: 2px solid #00d4ff;
            width: 80%; max-width: 350px; z-index: 30;
        }

        #nameInput {
            background: rgba(255, 255, 255, 0.1); border: 1px solid #00d4ff;
            color: white; padding: 10px; font-size: 16px; width: 90%;
            margin: 10px 0; text-align: center; border-radius: 5px;
        }

        button {
            background: #00d4ff; border: none; padding: 12px;
            color: black; font-weight: bold; font-size: 16px;
            border-radius: 8px; cursor: pointer; margin: 5px 0; width: 100%;
        }

        .color-selector { display: flex; justify-content: center; gap: 8px; margin: 10px 0; }
        .color-btn { width: 35px; height: 35px; border-radius: 50%; border: 3px solid transparent; }
        .color-btn.active { border-color: white; }

        .lives-container { color: #ff4d4d; font-size: 16px; }
        .hidden { display: none !important; }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; font-weight: bold; color: #00d4ff; pointer-events: none; z-index: 20; opacity: 0;
        }
        .animate-count { animation: flyIn 1s ease-out forwards; }
        @keyframes flyIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="ui">
    <div>Lvl: <span id="levelVal" style="color:#00d4ff">1</span></div>
    <div>Tgt: <span id="remainVal" style="color:#00d4ff">0</span></div>
    <div class="lives-container" id="livesVal">❤️❤️❤️</div>
    <div>Score: <span id="scoreVal">0</span></div>
</div>
<div id="warpProgress" class="hidden">WARP: <span id="warpCount">0</span>/3</div>
<div id="countdown"></div>

<div id="overlay">
    <div id="mainMenu">
        <h2 id="title" style="margin-top:0">TIME WARP</h2>
        <input type="text" id="nameInput" placeholder="YOUR NAME" maxlength="12">
        <div class="color-selector" id="colorPicker"></div>
        <button id="startBtn">START GAME</button>
        <button id="lbBtn" style="background: #444; color: white;">LEADERBOARD</button>
    </div>
    <div id="leaderboard" class="hidden">
        <h3>TOP 10</h3>
        <div id="lbContent" style="font-size:13px; text-align:left"></div>
        <button id="backBtn" style="background: #444; color: white; margin-top:10px;">BACK</button>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const startBtn = document.getElementById('startBtn');
const lbBtn = document.getElementById('lbBtn');
const backBtn = document.getElementById('backBtn');
const mainMenu = document.getElementById('mainMenu');
const leaderboard = document.getElementById('leaderboard');
const lbContent = document.getElementById('lbContent');
const nameInput = document.getElementById('nameInput');
const countdownEl = document.getElementById('countdown');
const livesEl = document.getElementById('livesVal');
const levelEl = document.getElementById('levelVal');
const colorPicker = document.getElementById('colorPicker');
const warpProgressEl = document.getElementById('warpProgress');
const warpCountEl = document.getElementById('warpCount');

let width, height;
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF', '#FFFF33'];
let selectedColor = colors[0];
let dots = [], score = 0, level = 1, lives = 3;
let gameState = 'waiting', animationId, lastTime = 0;
let shieldTime = 0, slowMoTime = 0, damageCooldown = 0, collectedInLevel = 0;

const touch = { x: width/2, y: height/2 };

const updateTouch = (e) => {
    e.preventDefault();
    const t = e.touches[0];
    if (t) { touch.x = t.clientX; touch.y = t.clientY; }
};
canvas.addEventListener('touchstart', updateTouch, {passive: false});
canvas.addEventListener('touchmove', updateTouch, {passive: false});

colors.forEach((color, index) => {
    const btn = document.createElement('div');
    btn.className = 'color-btn' + (index === 0 ? ' active' : '');
    btn.style.backgroundColor = color;
    btn.onclick = () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedColor = color;
    };
    colorPicker.appendChild(btn);
});

class Dot {
    constructor(x, y, r, color, isPlayer = false) {
        this.x = x; this.y = y; this.r = r; this.color = color;
        this.isPlayer = isPlayer;
        let speed = 0.8 + (level * 0.07);
        this.vx = (Math.random() - 0.5) * speed;
        this.vy = (Math.random() - 0.5) * speed;
    }

    draw() {
        ctx.save();
        if (this.isPlayer) {
            if (damageCooldown > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.2;
            ctx.shadowBlur = 10; ctx.shadowColor = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.strokeStyle = "white"; ctx.lineWidth = 2;
            ctx.fill(); ctx.stroke();
            if (shieldTime > 0) {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.r + 8, 0, Math.PI * 2);
                ctx.strokeStyle = "rgba(0,212,255,0.5)"; ctx.stroke();
            }
        } else {
            ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.fillStyle = this.color; ctx.fill();
        }
        ctx.restore();
    }

    update() {
        if (!this.isPlayer) {
            let f = (slowMoTime > 0) ? 0.2 : 1;
            this.x += this.vx * f; this.y += this.vy * f;
            if (this.x < 0 || this.x > width) this.vx *= -1;
            if (this.y < 0 || this.y > height) this.vy *= -1;
        } else {
            this.x += (touch.x - this.x) * 0.25;
            this.y += (touch.y - this.y) * 0.25;
        }
        this.draw();
    }
}

function startLevel() {
    dots = []; shieldTime = 3000; slowMoTime = 0; collectedInLevel = 0;
    levelEl.innerText = level;
    // Hráč začíná s poloměrem 10 (místo 14)
    player = new Dot(touch.x, touch.y, 10, selectedColor, true);
    
    // Nepřátelé jsou menší (5-8px místo 8-13px)
    let enemyCount = 15 + Math.min(level * 2, 40);
    for (let i = 0; i < level; i++) {
        dots.push(new Dot(Math.random()*width, Math.random()*height, 8, selectedColor));
    }
    for (let i = 0; i < enemyCount; i++) {
        let c; do { c = colors[Math.floor(Math.random()*colors.length)]; } while(c === selectedColor);
        dots.push(new Dot(Math.random()*width, Math.random()*height, 5 + Math.random()*3, c));
    }
    document.getElementById('remainVal').innerText = level;
    if (level >= 9) warpProgressEl.classList.remove('hidden');
}

let player;
function animate(t) {
    let dt = t - lastTime; lastTime = t;
    ctx.fillStyle = (slowMoTime > 0) ? 'rgba(0, 15, 30, 0.4)' : 'rgba(5, 5, 5, 0.4)';
    ctx.fillRect(0, 0, width, height);
    
    if (gameState === 'playing') {
        if (shieldTime > 0) {
            shieldTime -= dt;
            let v = Math.ceil(shieldTime/1000);
            if (v > 0) { countdownEl.innerText = v; countdownEl.className = 'animate-count'; }
            else { countdownEl.innerText = ''; }
        }
        if (slowMoTime > 0) slowMoTime -= dt;
        if (damageCooldown > 0) damageCooldown -= dt;

        player.update();

        for (let i = dots.length - 1; i >= 0; i--) {
            dots[i].update();
            let dist = Math.hypot(player.x - dots[i].x, player.y - dots[i].y);
            
            if (dist < player.r + dots[i].r) {
                if (dots[i].color === player.color) {
                    dots.splice(i, 1);
                    score += 10 * level;
                    collectedInLevel++;
                    // Přírůstek zmenšen na 0.2
                    player.r += 0.2; 
                    document.getElementById('scoreVal').innerText = score;
                    document.getElementById('remainVal').innerText = dots.filter(d => d.color === player.color).length;
                    
                    if (level >= 9) {
                        if (collectedInLevel % 3 === 0) slowMoTime = 3000;
                        warpCountEl.innerText = (collectedInLevel % 3);
                    }

                    if (dots.filter(d => d.color === player.color).length === 0) {
                        gameState = 'waiting'; level++;
                        overlay.classList.remove('hidden');
                        startBtn.innerText = "NEXT LEVEL: " + level;
                        confetti({particleCount: 80, spread: 50, origin: {y: 0.6}});
                    }
                } else if (damageCooldown <= 0 && shieldTime <= 0) {
                    lives--; damageCooldown = 2000;
                    player.r *= 0.8; // Při zásahu se kulička zmenší
                    livesEl.innerText = "❤️".repeat(lives);
                    if (lives <= 0) {
                        gameState = 'over';
                        overlay.classList.remove('hidden');
                        document.getElementById('title').innerText = "GAME OVER";
                        startBtn.innerText = "RETRY";
                        level = 1; score = 0; lives = 3;
                    }
                }
            }
        }
    }
    animationId = requestAnimationFrame(animate);
}

startBtn.onclick = () => { gameState = 'playing'; overlay.classList.add('hidden'); startLevel(); lastTime = performance.now(); if (!animationId) animate(lastTime); };
lbBtn.onclick = () => { mainMenu.classList.add('hidden'); leaderboard.classList.remove('hidden'); };
backBtn.onclick = () => { leaderboard.classList.add('hidden'); mainMenu.classList.remove('hidden'); };
</script>
</body>
</html>
